<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Shared Quiz - MrQuizzer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="settings.css">
    <style>
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            text-align: center;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #333;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Ajustes para el modal en share.html */
        .modal-overlay {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <div id="tos-modal" class="modal-overlay" style="display: flex; opacity: 1;">
        <article class="modal-container">
            <header class="modal-container-header">
                <span class="modal-container-title">
                    <svg aria-hidden="true" height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M14 9V4H5v16h6.056c.328.417.724.785 1.18 1.085l1.39.915H3.993A.993.993 0 0 1 3 21.008V2.992C3 2.455 3.449 2 4.002 2h10.995L21 8v1h-7zm-2 2h9v5.949c0 .99-.501 1.916-1.336 2.465L16.5 21.498l-3.164-2.084A2.953 2.953 0 0 1 12 16.95V11zm2 5.949c0 .316.162.614.436.795l2.064 1.36 2.064-1.36a.954.954 0 0 0 .436-.795V13h-5v3.949z" fill="currentColor"></path>
                    </svg>
                    Terms and Services
                </span>
            </header>
            <section class="modal-container-body rtf" id="tos-content">
                <p><strong>Please read carefully before proceeding.</strong></p>
                <p>By using MrQuizzer, you agree that you will not upload confidential, illegal, or copyrighted content that you do not have permission to use.</p>
                <p>We use security systems to actively monitor the use of our platform. Any attempts at reverse engineering or inappropriate use of the platform are strictly prohibited and will result in the permanent blocking of your access to our platform.</p>
                <p>This website and its contents are provided without guarantees of any kind. We are not responsible for its use or the results derived from its use.</p>
                <ul>
                    <li>Use AI responsibly.</li>
                    <li>Check generated answers for accuracy.</li>
                    <li>Data is processed locally where possible.</li>
                </ul>
                <p>Please click Accept to continue to the application.</p>
            </section>
            <footer class="modal-container-footer">
                <button class="button is-ghost" id="btn-decline">Decline</button>
                <button class="button is-primary" id="btn-accept">Accept</button>
            </footer>
        </article>
    </div>

    <main class="glass-card hidden" id="main-app">
        <div class="loading-container">
            <div id="status-icon" class="loader"></div>
            <h2 id="status-title">Importing Shared Quiz...</h2>
            <p id="status-msg" class="subtitle">Please wait while we set up your questions.</p>
            
            <div id="error-actions" class="hidden" style="margin-top: 20px;">
                <button onclick="window.location.href='./test_settings.html'" class="btn-start">Go to Settings</button>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('tos-modal');
            const mainApp = document.getElementById('main-app');
            const btnAccept = document.getElementById('btn-accept');
            const btnDecline = document.getElementById('btn-decline');

            const statusTitle = document.getElementById('status-title');
            const statusMsg = document.getElementById('status-msg');
            const statusIcon = document.getElementById('status-icon');
            const errorActions = document.getElementById('error-actions');

            // --- LÓGICA DE TOS ---
            const checkTOSStatus = () => {
                const tosAccepted = localStorage.getItem('mrquizzer_tos_accepted');
                if (tosAccepted === 'true') {
                    if (modal) modal.style.display = 'none';
                    if (mainApp) mainApp.classList.remove('hidden');
                    processSharedQuiz(); // Iniciar procesamiento si ya aceptó
                } else {
                    if (modal) {
                        modal.style.display = 'flex';
                        modal.style.opacity = '1';
                    }
                }
            };

            btnAccept.addEventListener('click', () => {
                localStorage.setItem('mrquizzer_tos_accepted', 'true');
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                    mainApp.classList.remove('hidden');
                    processSharedQuiz();
                }, 300);
            });

            btnDecline.addEventListener('click', () => {
                alert('You must accept the TOS to use MrQuizzer.');
                window.location.href = 'index.html'; 
            });

            // --- LÓGICA DE IMPORTACIÓN ---
            function processSharedQuiz() {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedData = urlParams.get('test');

                if (!encodedData) {
                    showError("No Quiz Data Found", "The link seems to be incomplete or broken.");
                    return;
                }

                try {
                    // Decode Base64
                    const decodedJson = decodeURIComponent(escape(atob(encodedData)));
                    const quizData = JSON.parse(decodedJson);

                    // Validation
                    if (!quizData.questions || !Array.isArray(quizData.questions)) {
                        throw new Error("Invalid quiz format");
                    }

                    // Save to sessionStorage
                    sessionStorage.setItem('mrquizzer_data', JSON.stringify(quizData));
                    
                    // Clear progress
                    localStorage.removeItem('mq_current_idx');
                    localStorage.removeItem('mq_score');
                    localStorage.removeItem('mq_timer');

                    // Success Redirect
                    statusTitle.textContent = "Quiz Loaded!";
                    statusMsg.textContent = "Redirecting you to the play area...";
                    
                    setTimeout(() => {
                        window.location.href = 'play.html';
                    }, 1200);

                } catch (e) {
                    console.error("Import Error:", e);
                    showError("Import Failed", "We couldn't read the quiz data. The link might be corrupted.");
                }
            }

            function showError(title, message) {
                statusTitle.textContent = title;
                statusMsg.textContent = message;
                statusIcon.style.display = 'none';
                errorActions.classList.remove('hidden');
            }

            // Iniciar verificación
            checkTOSStatus();
        });
    </script>
</body>
</html>